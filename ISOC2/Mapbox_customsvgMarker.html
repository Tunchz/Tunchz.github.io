<!DOCTYPE html>
<html>
<head>
  <!script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.6/mapbox.js'><!/script>
  <!link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.6/mapbox.css' rel='stylesheet' />

  <script src='js/mapbox-gl_v1120.js'></script>
  <link rel="stylesheet" href="css/mapbox-gl_v1120.css">

  <style>
body {
  margin: 0;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
}

#map {
  position: absolute;
  width: 100%;
  height: 100%;
}

.marker svg {
  width: 100%;
  height: 100%;
}
.marker{
  pointer-events:none;
}
  </style>
</head>
<body>
<div id='map'></div>
<svg id='marker' xmlns="http://www.w3.org/2000/svg" version="1.1">
<circle cx="25" cy="25" r="25" style="fill:#00f" />
</svg>
<script>
/**********************************************************/
/****                                                  ****/
/****                                                  ****/
/****              THINGS TO CHANGE                    ****/
center = [-0.1099169667957085, 51.51168978882151];
zoomLevelOnStart = 18;
geoReferenceWidthInMeters = 150;
geoReferenceHeightInMeters = 150;
imageURL =
  "https://upload.wikimedia.org/wikipedia/commons/3/30/Vector-based_example.svg";
/****                                                  ****/
/**********************************************************/

mapboxgl.accessToken =
  "pk.eyJ1IjoiYTEwayIsImEiOiJjaWdyMmVrazcwMXpsdTZtMThscWtiOTJtIn0.-A76dzJ0vsKULJdDxGvVXg";

var map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/light-v10",
  pitchWithRotate: false,
  
  center: center,
  zoom: zoomLevelOnStart
});
var svgContainer;
var markerContainer = document.createElement("div");
markerContainer.className = "marker";

Snap.load(imageURL, function(f) {
  Snap(markerContainer).append(f);
  svgContainer = f.node;
  new mapboxgl.Marker(markerContainer).setLngLat(center).addTo(map);
});

function getScale(n, m) {
  var center = map.getCenter();
  var zoom = map.getZoom();
  var tmp =
    156543.03392 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, zoom);
  var meterSizeInPixelN = n / tmp;
  var meterSizeInPixelM = m / tmp;
  return [meterSizeInPixelN, meterSizeInPixelM];
}

function render() {
  var pixelSizes = getScale(
    geoReferenceWidthInMeters,
    geoReferenceHeightInMeters
  );
  markerContainer.style.width = pixelSizes[0] + "px";
  markerContainer.style.height = pixelSizes[1] + "px";
  //svgContainer && (svgContainer.style.transform = "rotate(" + -map.getBearing() + "deg)");
}

// re-render our visualization whenever the view changes
map.on("viewreset", render);
map.on("zoom", render);
map.on("drag", render);
map.on("rotate", render);
render();

//Disable rotation only for codepen demo, setting the style transform is also commented in render, this seems to be very slow in codepen embed. in general it works fine though..
// disable map rotation using right click + drag
map.dragRotate.disable();
// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();
</script>
</body>
</html>