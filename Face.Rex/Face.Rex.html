<!doctype html>
<html lang="en" class="no-js">
  <head>
  	<meta charset="UTF-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>z.et.ZERO.Face.Rex : the question isn't can you; it's WILL YOU. -FWTT-</title>
    <meta name="description" content="the question isn't can you; it's WILL YOU. -FWTT-">
    <link rel="stylesheet" href="css/covid19.min.css">
    <link rel="stylesheet" href="css/FWTT.css">
    <link rel="stylesheet" href="css/fonts.css">
  </head>
  <body>
    <div class = "section-container">
      <div class = "col-sm-8 height10p" style = "background-color: #fff">

      </div>
      <div class = "col-sm-4 height10p" style = "background-color: #383838">

      </div>
      <div class = "col-sm-8 height90p" style = "background-color: #fff;">
         <div id="video-container">
          <video id="video" width="640" height="480" autoplay muted></video>
        </div>       
        <!div id="map-container">
          <!div id="map"><!/div>
        <!/div>
      </div>
      <div class = "col-sm-4 height90p" style = "background-color: #383838">
        <div id="table-container" oncontextmenu="return false;">
        </div>
      </div>
    </div>
  </body>

  <script defer src="js/face-api.min.js"></script>
  <script src="js2/d3.v355.min.js"></script>
  <!script src='js2/mapbox-gl.js'><!/script>
  <script src="js2/crossfilter.min.js"></script>
  <script src="js2/jquery.min.js"></script>
  <!script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"><!/script>
  <script defer src="Face.Rex.js"></script>

  <script>

    var formatTime = d3.time.format("%d %B %Y %H:%M:%S");
    var chartData,
        refresh_rate = i = 4,
        windowlength = 200
        z = 2;
        //transitiontime = 100;
    var sensor = [],
        sensor2 = [/*{"lat":0, "lon":0}*/];
    var timenow = new Date;

        timenow = new Date(timenow.getTime() - (refresh_rate*windowlength*1000));
/*    var j;
    for (j = 0; j < windowlength; j++) {
        sensor.unshift({ 'pm25' : 0,                         //sensor.push({ 'pm25' : 0,                     
                      'humd' : 0,                          
                      'temp' : 0,                         
                      'light' : 0,                        
                      'pm10' : 0,
                      'lat' : 0,     
                      'lon' : 0,     
                      'name' : "เสือผู้ไม่กินเหยื่อซ้ำ",
                      'date' : new Date(timenow.getTime() + (refresh_rate*j*1000))
        });
    }
*/
/*
    mapboxgl.accessToken = 'pk.eyJ1IjoidHVuY2h6IiwiYSI6ImNqcnU5NTRmMzJ0NHAzeWw5MTc1YzN4cGQifQ.jSjhGqwnq-8XjfgRlf4JNg'
    
    //Setup mapbox-gl map
    var map = new mapboxgl.Map({
      //style: 'mapbox://styles/tunchz/ck9litjbw2soc1iqo4rysy4nt',
      //style: 'mapbox://styles/mapbox/streets-v11',
      //style: 'mapbox://styles/mapbox/cjaudgl840gn32rnrepcb9b9g',  // the outdoors-v10 style but without Hillshade layers
      //style: 'mapbox://styles/mapbox/outdoors-v10',
      //style: 'mapbox://styles/mapbox/dark-v10',
      style: 'mapbox://styles/mapbox/satellite-v9',
      //style: 'mapbox://styles/mapbox/light-v10',
      container: 'map', // container id
      center: [101.1673626,14.2808669],
      minZoom: 5,
      maxZoom: 20,
      zoom: 12,
      pitch: 90,
      //bearing: -17.6,
      antialias: true

    })


    map.addControl(new mapboxgl.FullscreenControl());//, 'top-left');
    // Add geolocate control to the map.
    map.addControl(new mapboxgl.GeolocateControl({positionOptions: {enableHighAccuracy: true},trackUserLocation: true}));//, 'top-left');
    map.addControl(new mapboxgl.NavigationControl());//, 'top-left');

*/

    //refresh();
    //drawmap(map,sensor);

    //tick();



    function tabulateimg(data, columns) {


      var table = d3.select('#table-container').append('table').attr("id","table_image");

      //var thead = table.append('thead')
      var tbody = table.append('tbody');
      var dummy = [];

      for (t=0; t<data.length; t++) {
        data[t].row_no = t;
      }
      columns.push('row_no');
      //console.log(data);
    //console.log("1",img_col==null)
    /*
      // append the header row
      thead.append('tr')
        .selectAll('th')
        .data([img_col[0],'detail']).enter()
        .append('th')
          .text(function (column) { return column; });
    */
      // create a row for each object in the data
      var rows = tbody.selectAll('tr')
        .data(data)
        .enter()
        .append('tr')
        .attr('class','table_row')
        .attr('id',function(d) {return 'row-'+d.id});

      // create a cell in each row for each column

      //------ 1st column section ------------------------------------------------------------------  
      var img_cells = rows.selectAll('td')
        .data(function (row) { //console.log(row);
          return ["img"/*columns[0]*/].map(function (column) {
            return {column: column, value: row[column], status:row["status"]};
          });
        })
        .enter()
        .append('td').attr("class","img_col")
        .append('div')
        .attr('class', 'table_img_container')
        .append('img')
        .attr('class', 'table_img')
        .attr('src', function(d) {return d.column == columns[0] ?  d.value : null;})
        .style("border",function (d) {
              if (d.status == "succeeded") {
                return "3px solid #9bee00"
              } else if (d.status == "sending") {
                return "3px solid #ffcc00"
              } else if (d.status == "failed") {
                return "3px solid #316be6"
              } else {
                return "3px solid #ff0000"
              }
        });

      //------ 2nd column section ------------------------------------------------------------------  
      var cells = rows.selectAll('td')
        .data(function (row) {
          //console.log(row);
          return ['img','detail'].map(function (column) {
            var dt = {};
            for (m=1; m < 4 /*columns.length*/; m++) {
              if (columns[m] == 'id') {
                if ((row[columns[m]].substr(0,1)) != 'u') {
                  dt[columns[m]] = facelabels[parseInt(row[columns[m]])];
                } else {
                  dt[columns[m]] = row[columns[m]];
                }
                
              } else {
                dt[columns[m]] = row[columns[m]];
              }
     
            }
            //console.log(dt);
            return {column: column, value: dt /*{"detail" : row[columns[1]], "subdetail_1" : row[columns[2]], "subdetail_2" : row[columns[3]]}*/};
          });
        })
        .enter()
        .append('td').attr("class","detail_col")
        .append('table').attr("id","detail_table");

        var cthead = cells.append('thead')
        var ctbody = cells.append('tbody');

        // Display detail as table header
        cthead.append('tr')
          .selectAll('th')
          .data(function (d) {/*console.log(d.value[columns[1]]);*/ return [d.value[columns[1]]]})
          .enter()
          .append('th')
            .attr('class', 'detail')
            .text(function (column) {return column })

        // Display subdetail as table row 
        var crows = ctbody.selectAll('tr')
          .data(function (d) {return [d.value[columns[2]],d.value[columns[3]]]})
          .enter()
          .append('tr')
          .append('th')
            .attr('class', 'subdetail')
            .text(function (column) {return column })

      //------ 3rd column section ------------------------------------------------------------------         
      var cells2 = rows.selectAll('td')
        .data(function (row) {
          //console.log(row);
          return ['img','detail','tag'].map(function (column) {
            var dt = {};
            for (m=4; m<columns.length; m++) {
              /*if (m == 7) {
                dt['row_no'] = row['row_no'];
              } else if (columns[m] == 'lat') {
                dt[columns[m]] = '●';
              } else {
                dt[columns[m]] = row[columns[m]];
              } */    
              dt[columns[m]] = row[columns[m]];
            }
            //console.log(dt);
            return {column: column, value: dt /*{"detail" : row[columns[1]], "subdetail_1" : row[columns[2]], "subdetail_2" : row[columns[3]]}*/};
          });
        })
        .enter()
        .append('td').attr("class","tag_col")
        .append('table').attr("id","tag_table");

        var cthead2 = cells2.append('thead')
        var ctbody2 = cells2.append('tbody');

        // Display detail as table header
        cthead2.append('tr')
          .selectAll('th')
          .data(function (d) {/*console.log(d.value[columns[1]]);*/ return [d.value[columns[4]]]})
          .enter()
          .append('th')
            .attr('class', 'tag')
            .text(function (column) {return column })

        // Display subdetail as table row 
        var crows2 = ctbody2.selectAll('tr')
          .data(function (d) {return [{value : d.value[columns[5]], name : "mood", row : d.value[columns[8]]},{value : d.value[columns[6]], name : "status", row : d.value[columns[8]], detection : d.value[columns[7]]}]})
          .enter()
          .append('tr')
          .append('th')
            .attr('id',function(d) {/*console.log(d);*/return 'subtag-'+d.row+'-'+d.name})
            .attr('class', 'subtag')
            .text(function (column) {return column.name == "mood"? column.value : column.detection + " " + (column.value == 'succeeded' ? '✔': column.value == 'failed' ? '✘': '❗' )})

/*
        if (data[t].status == 'succeeded') {
          data[t].status = '✔';
        } else if (data[t].status == 'failed') {
          data[t].status = '✘';
        } else {
          data[t].status = '❗';
        }

*/

      return table;
    }

    function project(m,d) {
      return m.project(new mapboxgl.LngLat(+d.lon, +d.lat)/*getLL(d)*/);
    }

    function markerupdate(m,d) {
      d
      .attr({
        cx: function(d) { 
          var x = project(m,d).x;
          return x
        },
        cy: function(d) { 
          var y = project(m,d).y;
          return y
        },
      })
    }

    function zoom(d) {
      if (d==0) {
        return 18.5;
      } else if (d==1) {
        return 16;
      } else if (d==2) {
        return 12;
      } else if (d==3) {
        return 9;
      } else {
        return 5;
      }
    }

    function drawmap(data){
      //remove all old markers and popups
      markers = d3.select("#map").selectAll(".marker");
      markers.remove();
      popups = d3.select("#map").selectAll(".mapboxgl-popup");
      popups.remove();

      var popups={},j = 0,index = {};
      
      for (j = 0; j < data.length; j++) {
        index[data[j].id] = j;
        
        if (data[j].lat!=0 && data[j].lon!=0){
          
          //console.log(data[j].name,data[j].lat,data[j].lon);
          var el = document.createElement('div');
          el.className = 'marker';
          el.id = 'marker-'+ data[j].id;

          // make a marker for each feature and add to the map
          new mapboxgl.Marker(el)
          .setLngLat([data[j].lon,data[j].lat])
          .addTo(map);

          popups[data[j].id] = new mapboxgl.Popup({ offset: 25, closeButton: false, closeOnClick: false }).setHTML('<strong>┃ '+data[j].name+'</strong><small><br> ▸  '+ data[j].status+ '  ' + data[j].detail+ '<br> ▸ '+formatTime(data[j].timestamp)+ /*'<br> ▸ Lat: '+ data[j].lat +'  Lat: '+ data[j].lon +*/ '<br> ▸  '+ data[j].location+ '</small>');

          //d3.select("#map").selectAll("#marker-"+j).style("background-image","url('img/"+ data[j].name +".jpg')");
          d3.select("#map").selectAll("#marker-"+data[j].id)
            .style("background-image","url('img/เสือผู้ไม่กินเหยื่อซ้ำ.jpg')")
            .style("border",function (d) {
              if (data[j].status == "มาทำงาน") {
                return "2px solid #9bee00"
              } else if (data[j].status == "ทำงานที่บ้าน") {
                return "2px solid #ffcc00"
              } else if (data[j].status == "ราชการ") {
                return "3px solid #316be6"
              } else {
                return "2px solid #ff0000"
              }
            })
            ;

          d3.select("#map").selectAll(".marker")
            .on('mouseover', function(e) {
              d3.select("#map").selectAll(".marker").style('opacity',0.6);
              id = d3.select(this).attr('id').split("-")[1];
              k=index[id]; 
              d3.select("#marker-"+data[k].id).style('opacity',1).style('height','45px').style('width','45px').style('z-index',2);
              popups[id].setLngLat([data[k].lon,data[k].lat]).addTo(map);})
            .on('mouseout', function(e) {
              d3.select("#map").selectAll(".marker").style('opacity',1).style('height','30px').style('width','30px').style('z-index',0);
              popup = popups[d3.select(this).attr('id').split("-")[1]]; popup.remove();})
            .on('click', function(d) {z!=0 ? z = z - 1 : z = z; k=index[d3.select(this).attr('id').split("-")[1]]; map.flyTo({ center: [data[k].lon,data[k].lat], zoom : zoom(z)});})
            .on('contextmenu', function(d) {z!=4 ? z = z + 1 : z = z; k=index[d3.select(this).attr('id').split("-")[1]]; map.flyTo({ center: [data[k].lon,data[k].lat], zoom : zoom(z)});});

        } //if
      } //for

      tabulateimg(data, ["img","name","status","timestamp"]);


          d3.select("#table-container").selectAll(".table_row")
            .on('mouseover', function(e) {
              d3.select("#map").selectAll(".marker").style('opacity',0.6);
              id=d3.select(this).attr('id').split("-")[1]; 
              k = index[id]
              d3.select("#marker-"+id).style('opacity',1).style('height','45px').style('width','45px').style('z-index',2);
              popups[id].setLngLat([data[k].lon,data[k].lat]).addTo(map);
            })
            .on('mouseout', function(e) {
              d3.select("#map").selectAll(".marker").style('opacity',1).style('height','30px').style('width','30px').style('z-index',0);
              popup = popups[d3.select(this).attr('id').split("-")[1]]; popup.remove();})
            .on('click', function(d) {z!=0 ? z = z - 1 : z = z; k=index[d3.select(this).attr('id').split("-")[1]]; map.flyTo({ center: [data[k].lon,data[k].lat], zoom : zoom(z)});})
            .on('contextmenu', function(d) {z!=4 ? z = z + 1 : z = z; k=index[d3.select(this).attr('id').split("-")[1]]; map.flyTo({ center: [data[k].lon,data[k].lat], zoom : zoom(z)});});
    }


    function refresh(){
      d3.json("http://122.155.11.222:1880/checkin?", function(error, data2) {

        var formatDate = d3.time.format("%Y-%m-%d"),
            formatTime = d3.time.format("%H:%M:%S");


        if (!error) {
          //console.log(data2.length);
          for (j = 0; j < data2.length; j++) {
            sensor2.push({ 'name' : data2[j].name,
                        'id' : j,     
                        'img' : 'img/เสือผู้ไม่กินเหยื่อซ้ำ.jpg',             
                        'lat' :+parseFloat(data2[j].latitude).toFixed(6),
                        'lon' : +parseFloat(data2[j].longitude).toFixed(6),
                        'status': data2[j].status,
                        'detail': data2[j].detail,
                        'location': data2[j].location,
                        'timestamp' : new Date(data2[j].timestamp),
                        'date' : formatDate(new Date(data2[j].timestamp)),
                        'time' : formatTime(new Date(data2[j].timestamp)),
            });            
          }
        }
        var sf = crossfilter(sensor2);
        sf.date = sf.dimension(function(d) { return d.date; });

        var sensor2_filtered = sf.date.filterExact("2020-05-18").bottom(Infinity)

        //drawmap(sensor2_filtered);

        tabulateimg(sensor2_filtered, ["img","name","status","timestamp","time","lat","lon"]);
      });
    }

    function tick() {
      setTimeout(tick, 1000 - Date.now() % 1000);
      var now = new Date;
      document.getElementById("TimeDisplay").innerHTML = formatTime(now)+" ▸ refresh in "+i+ " secs";
      if (i<=0) {
        refresh();
          i = refresh_rate;
      } 
      i -= 1;
    }


  </script>



</html>
