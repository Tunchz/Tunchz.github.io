import{S as Qe,s as _e,a as et}from"./index-S46iqhiS.js";import{i as tt,z as rt}from"./zoom-BnyqM2yK.js";import{i as lt,q as nt,T as at,u as se,L as j,v as Z,k as G,o as ot,w as J}from"./_plugin-vue2_normalizer-xzsEtbse.js";import{e as it,h as ut,f as st,g as ct}from"./main-CVmQxpd7.js";import{f as Le}from"./defaultLocale-B8TAAL35.js";import{s as N}from"./selectAll-Cx8JdGyI.js";import"./min-D1slsF82.js";import"./sum-CB6J5KXz.js";import"./max-DBeXZoyG.js";import"./index-CB7DGV00.js";import"./constant-I5scnKCP.js";import"./point-DWREGWZc.js";import"./index-BNR9-8HJ.js";import"./touch-Dr12ZUMz.js";import"./index-BvYcEE5T.js";function zt(o,l,r,f){let k=new Map,x=new Map;f.extraSettings[11],lt()&&o.reverse();let m=f.dimensions[0],g=f.dimensions[1],d=l[0],C=l[1],A=r,c=1;for(let h of o){let p=h[d].formattedValue,b=h[C].formattedValue,P=nt(h,A);if(Number.isNaN(P))throw new Error("The selected measure contains non-numeric values.");if(P<=0)throw new Error("The selected measure contains values smaller than or equal to 0. Please select a different measure that only contains positive values.");x.has(p)||(x.set(p,{name:p,dimension:m,id:p,orderBy:c.toString()}),c++),x.has(b)||(x.set(b,{name:b,dimension:g,id:b,orderBy:c.toString()}),c++);let v=p+b;k.has(v)&&(P+=k.get(v).value),k.set(v,{source:p,target:b,value:P})}let S=Array.from(x.values());S.sort((h,p)=>p.height-p.height);let y=Array.from(k.values());return y=y.filter(h=>h.source!==h.target),{nodes:S,links:y}}let K=null;function At(o,l,r){let{measureName:f,measureFormat:k,measureStyle:x,color:m,width:g,height:d,mixBlendMode:C,fontSize:A,extraSettings:c,isDarkTheme:S,dimensionColors:y,memberColors:h,valueColors:p,useNewColorFormat:b,enableLegend:P,legendPosition:v,legendRows:M,legendColumns:I,legendPaddingX:Pe,legendPaddingY:qe,legendType:fe,scaleLegendItems:me,scaleLegendColor:He,scaleLegendOrder:Ve}=r;const F=new at("#tooltip",g,d);let i=c[0]||"value",_=c[1]||"both",ee=parseInt(c[2])||100,Me=parseInt(c[3])||6,q=parseInt(c[4])||0,ze=(parseFloat(c[5])+1||50)/100,Ae=(parseFloat(c[6])+1||100)/100,Ie=c[7]||"sankeyLeft",Oe=c[8]==="1"?1:0,Fe=c[9]==="0"?0:1,H=c[10]||"inside",V=r.extraSettings[11]==="0"?0:1,X=c[12]||"auto",de=c[13]||"auto",pe=parseInt(c[14])||1,ge=parseInt(c[15])+1||45,he=parseInt(c[16])+1||16,Be=c[17]||"0",Re=c[18]||(r!=null&&r.textColor?r.textColor:"#ffffff"),ve=c[19]||(r!=null&&r.textColorLinks?r.textColorLinks:"#ffffff"),$e=c[20]||"#000000",De=c[21]||"#dddddd",te=c[22]||"0",re=c[23]||"0",ye=new Intl.Collator(void 0,{usage:"sort"}).compare;k||(k=".1f");let B=Le(k);x&&(B=ot(x));let R=Le(".1%"),le=5,xe=0,ke=le,be=g-le,ne=d-le,T=l.nodes.length*pe*g/d,L=l.nodes.length*pe;T=T<g?g:T,L=L<d?d:L,T=T<l.nodes.length*10*g/d?l.nodes.length*10*g/d:T,L=L<l.nodes.length*10?l.nodes.length*10:L,P&&(v==="left"&&(ke+=I*100+35),v==="right"&&(be-=I*100+45),v==="bottom"&&(ne-=M*18+60)),i==="unique"&&v==="bottom"&&(ne-=(M-1)*16);let Ye=v==="left"?T/g*ke:0,U=v==="right"?T/g*(I*100+45):0;U=H==="outside"?U+150:U;let Ee=v==="top"?L/d*(M*18+30+xe):L/d*xe,Ge=v==="bottom"?L/d*(M*18+60):0,Xe=Qe().nodeAlign(_e[Ie]).nodeWidth(ee).nodePadding(Me*(L/d)).linkSort(function(e,t){if(e.source.name==="Null")return!0;if(de==="valueHighToLow")return t.value-e.value;if(de==="valueLowToHigh")return e.value-t.value}).nodeSort(function(e,t){if(e.name==="Null")return!0;if(X==="asc")return ye(e.name,t.name);if(X==="desc")return ye(t.name,e.name);if(X==="valueHighToLow")return t.value-e.value;if(X==="valueLowToHigh")return e.value-t.value}).nodeId(e=>e.id).extent([[-T/2+Ye,-L/2+Ee],[T/2-U,L/2-Ge]]);o.on("click",Q);let Ue=o.append("g").attr("class","links").attr("fill","none").attr("stroke-opacity",ze),We=o.append("g").attr("class","nodes").attr("font-size",A+"rem"),je=N(".nodes,.links");var we=tt.translate(g/2,d/2).scale(d/L);function Je(){let{x:e,y:t,k:a}=Z.transform;je.attr("transform",`translate(${e},${t}) scale(${a})`)}var ae=rt().on("zoom",Je);o.call(ae).call(ae.transform,we),o.on("dblclick.zoom",null);function Ze(){ae.transform(o,we)}Xe(l);let oe=We.selectAll(".node").data(l.nodes).enter().append("g").attr("class","node");oe.append("rect").attr("class","node-rect").filter(e=>V?e.name!=="Null":!0).attr("x",e=>e.x0+q*2).attr("y",e=>e.y0).attr("width",e=>{let t=e.x0+q*2;return e.x1-t-q*2}).attr("fill",e=>{if(b)if(i==="unique"){for(var t=null,a=e.dimension+" - "+e.name,n=0;n<p.length;n++)p[n].fieldName==a&&(t=p[n].color);return t||m(i==="unique"?e.id:i==="value"?e.name:e.dimension)}else if(i==="value"){for(var t=null,u=0;u<h.length;u++)h[u].fieldName==e.name&&(t=h[u].color);return t||m(i==="unique"?e.id:i==="value"?e.name:e.dimension)}else if(i==="dimension"){let s=e.layer,w=null;return r.levelColorsArray[s]&&(w=r.levelColorsArray[s].color),w==null&&(w="black"),w}else{for(var t=null,u=0;u<y.length;u++)y[u].fieldName===e.dimension&&(t=y[u].color);return t||m(i==="unique"?e.id:i==="value"?e.name:e.dimension)}else return m(i==="unique"?e.id:i==="value"?e.name:e.dimension)}).classed("focus",e=>e.dimension===K).on("click",Be==1?mt:ft).on("mouseover",e=>{F.show(r.tooltips.node.content||r.tooltips.node,{DimensionName:e.dimension,DimensionValue:e.name.bold(),MeasureName:f,MeasureValue:B(e.value).bold()}),z(e)}).on("mousemove",()=>{F.updatePosition()}).on("mouseout",()=>{F.hide(),O()}),oe.selectAll("rect").filter(e=>V?e.name!=="Null":!0).attr("stroke-width",e=>Oe?1:0).attr("stroke",$e).attr("fill-opacity",Ae).attr("height",e=>e.y1-e.y0<5?5:e.y1-e.y0);let D=Ue.selectAll(".link").data(l.links).enter().append("g").attr("class","link").style("mix-blend-mode",C);if(_==="both"){let e=D.append("linearGradient").attr("id",t=>`link-${t.index}`).attr("gradientUnits","userSpaceOnUse").attr("x1",t=>t.source.x1).attr("x2",t=>t.target.x0);e.append("stop").attr("offset","0%").attr("stop-color",t=>{if(b)if(i==="unique"){var a=null;let u=t.source.dimension+" - "+t.source.name;for(var n=0;n<p.length;n++)p[n].fieldName===u&&(a=p[n].color);return a||m(i==="unique"?t.source.id:i==="value"?t.source.name:t.source.dimension)}else if(i==="value"){for(var a=null,n=0;n<h.length;n++)h[n].fieldName===t.source.name&&(a=h[n].color);return a||m(i==="unique"?t.source.id:i==="value"?t.source.name:t.source.dimension)}else if(i==="dimension"){let u=t.source.layer,s=null;return r.levelColorsArray[u]&&(s=r.levelColorsArray[u].color),s==null&&(s="black"),s}else{for(var a=null,n=0;n<y.length;n++)y[n].fieldName===t.source.dimension&&(a=y[n].color);return a||m(i==="unique"?t.source.id:i==="value"?t.source.name:t.source.dimension)}else return m(i==="unique"?t.source.id:i==="value"?t.source.name:t.source.dimension)}),e.append("stop").attr("offset","100%").attr("stop-color",t=>{if(b)if(i==="unique"){var a=null;let u=t.target.dimension+" - "+t.target.name;for(var n=0;n<p.length;n++)p[n].fieldName===u&&(a=p[n].color);return a||m(i==="unique"?t.target.id:i==="value"?t.target.name:t.target.dimension)}else if(i==="value"){for(var a=null,n=0;n<h.length;n++)h[n].fieldName===t.target.name&&(a=h[n].color);return a||m(i==="unique"?t.target.id:i==="value"?t.target.name:t.target.dimension)}else if(i==="dimension"){let u=t.target.layer,s=null;return r.levelColorsArray[u]&&(s=r.levelColorsArray[u].color),s==null&&(s="black"),s}else{for(var a=null,n=0;n<y.length;n++)y[n].fieldName===t.target.dimension&&(a=y[n].color);return a||m(i==="unique"?t.target.id:i==="value"?t.target.name:t.target.dimension)}else return m(i==="unique"?t.target.id:i==="value"?t.target.name:t.target.dimension)})}if(D.append("path").attr("class","link").on("click",dt).filter(e=>V?e.source.name!=="Null"||e.target.name!=="Null":!0).on("mouseover",e=>{F.show(r.tooltips.link.content||r.tooltips.link,{MeasureName:f,MeasureValue:B(e.value).bold(),PercentOfSource:R(e.value/e.source.value).bold(),SourceName:e.source.name.bold(),PercentOfTarget:R(e.value/e.target.value).bold(),TargetName:e.target.name.bold()}),z(e)}).on("mousemove",()=>{F.updatePosition()}).on("mouseout",()=>{F.hide(),O()}),r.labels.fromLink.enabled&&D.append("foreignObject").attr("width",300).attr("height",300).filter(e=>e.width>he?V?e.source.name!=="Null":!0:!1).attr("x",function(e){return e.source.x1+2}).attr("y",function(e){return e.y0-8*A}).style("pointer-events","none").attr("color",ve).html(function(e){return se(r.labels.fromLink.content,{MeasureName:f,MeasureValue:B(e.value),PercentOfSource:R(e.value/e.source.value),SourceName:e.source.name,PercentOfTarget:R(e.value/e.target.value),TargetName:e.target.name})}),D.select("path").attr("d",et()).filter(e=>V?e.target.name!=="Null"&&e.source.name!=="Null":!0).attr("stroke",e=>{if(b){let n=i==="unique"?e.source.dimension+" - "+e.source.name:i==="value"?e.source.name:e.source.dimension,u=i==="unique"?e.target.dimension+" - "+e.target.name:i==="value"?e.target.name:e.target.dimension,s=i==="unique"?p:i==="value"?h:y;switch(_){case"none":return De;case"both":return`url(#link-${e.index})`;case"input":for(var a=null,t=0;t<s.length;t++)s[t].fieldName===n&&(a=s[t].color);return a;default:for(var a="#ddd",t=0;t<s.length;t++)s[t].fieldName===u&&(a=s[t].color);return a}}else switch(_){case"none":return"#ddd";case"both":return`url(#link-${e.index})`;case"input":return m(i==="unique"?e.source.id:i==="value"?e.source.name:e.source.dimension);default:return m(i==="unique"?e.target.id:i==="value"?e.target.name:e.target.dimension)}}).attr("stroke-width",e=>Math.max(1,e.width)),r.labels.toLink.enabled&&D.append("foreignObject").attr("width",300).attr("height",300).filter(e=>e.width>he?V?e.target.name!=="Null":!0:!1).attr("x",function(e){return e.target.x0-300-2}).attr("y",function(e){return e.y1-8*A}).style("pointer-events","none").attr("color",ve).html(function(e){return'<div style="text-align: right">'+se(r.labels.toLink.content,{MeasureName:f,MeasureValue:B(e.value),PercentOfSource:R(e.value/e.source.value),SourceName:e.source.name,PercentOfTarget:R(e.value/e.target.value),TargetName:e.target.name})+"</div>"}),Fe&&r.labels.node.enabled||r.labels.node.enabled){let e=l.nodes.map(t=>t.laya);e=Math.max(...e),oe.append("foreignObject").attr("width",t=>H==="outside"?150:t.x1-t.x0+q-10).attr("height",t=>t.y1-t.y0).filter(t=>ge<=1?!0:t.y1-t.y0>ge?V?t.name!=="Null":!0:!1).attr("x",t=>H==="outside"?t.x0-q-100:t.x0+q).attr("y",t=>t.y0).attr("dy","0.35em").attr("text-anchor",H==="outside"?"end":"start").style("pointer-events","none").attr("color",Re).html(function(t){const a=()=>{let n=se(r.labels.node.content,{DimensionName:t.dimension,DimensionValue:t.name,MeasureName:f,MeasureValue:B(t.value)}),u=()=>{let s="width :100%;";return te==="0"?s+="text-align:left;":te==="1"?s+="text-align:center;":te==="2"&&(s+="text-align:right;"),re==="0"&&(s+="top:0;transform:translateY(0);"),re==="1"&&(s+="top:50%;transform:translateY(-50%);"),re==="2"&&(s+="top:100%;transform:translateY(-100%);"),s+="padding-left:5px;padding-right:5px;padding-top:8px;padding-bottom:8px;position:absolute;",s};return H==="outside"?`<div style="${u()}" line-height:1;>${n}</div>`:`<div style="${u()}line-height:1;">${n}</div>`};if(V&&t.name!=="Null")return a();if(!V)return a()}).filter(t=>H==="outside"?t.x0<g/2:t.x0+2).attr("x",t=>H==="outside"?t.layer==e?t.x1-ee*2:t.x1+6:t.x1-ee+q*2+5).attr("text-anchor","start"),H==="inside"&&N("text").call(gt,a=>{let n=a.x0+q*2;return a.x1-n-q*2})}if(P){let e=P&&v==="right"?be+20:10,t=P&&v==="bottom"?ne+10:20;if(e+=parseInt(Pe),t+=parseInt(qe),t+=0,fe==="color"){if(i==="value")new j(o,l.nodes,S).title(r.legendTitle?r.legendTitle:"Values").text(a=>a.name).offset(e,t).positioning(v).nrRows(M).nrColumns(I).legendType("color").color(a=>{if(b){for(var n=0;n<h.length;n++)if(h[n].fieldName===a)return h[n].color}else return m(a)}).highlight(z).clearHighlight(O).draw();else if(i==="unique")new j(o,l.nodes,S).title(r.legendTitle?r.legendTitle:"Values").text(a=>a.name).formattedText(a=>a.name).offset(e,t).positioning(v).nrRows(M).nrColumns(I).legendType("color").color(a=>{if(b){for(var n=0;n<p.length;n++)if(p[n].fieldName.split(" - ").pop()===a)return p[n].color}else return m(a)}).highlight(z).clearHighlight(O).draw();else if(i==="dimension"){let a=l.nodes.map(u=>JSON.stringify(u.layer)),n=[...new Set(a)];n.sort(function(u,s){return u.localeCompare(s)}),new j(o,n,S).title(r.legendTitle?r.legendTitle:"Dimensions").text(u=>`Level ${u}`).offset(e,t).positioning(v).nrRows(M).nrColumns(I).legendType("color").color(u=>{if(b){let s="#dddddd",w=u.split("Level ")[1];return r.levelColorsArray[w]&&(s=r.levelColorsArray[w].color),s}else return m(u)}).highlight(z).clearHighlight(O).draw()}}else fe==="scale"&&(async()=>{for(;!l.links[0].width;)await new Promise(W=>setTimeout(W,100));let a=l.links[0].value/l.links[0].width;for(var n=9999999,u=0,s=0;s<l.links.length;s++)l.links[s].value<n&&(n=l.links[s].value),l.links[s].value>u&&(u=l.links[s].value);var w=[];let ie=u-n,ue=me,Ke=ie/(ue-1);for(var $=0;$<ue;$++)w[$]=$===0?J(n):$===ue-1?J(u):J(n+Ke*$);me==="1"&&(w[0]=J(u)),Ve==="high-low"&&w.reverse(),new j(o,w,S).title(r.legendTitle?r.legendTitle:"Scale legend").text(W=>W.name).offset(e,t).positioning(v).nrRows(M).nrColumns(I).legendType("scale").setPixelValue(a).color(W=>He).highlight(z).clearHighlight(O).draw()})()}function Ne(e,t,a,n){o.append("g").attr("class","reset").append("circle").attr("fill","#ffffff").attr("cx",e).attr("cy",t).attr("r",15).attr("stroke","#ddd").attr("fill","#69a3b2").attr("pointer-events","all").attr("fill","#ddd").attr("width",110).attr("height",20).attr("opacity",1).on("click",function(){Ze(),G(this).attr("opacity",0),N(".buttonText").remove()}),o.append("g").attr("class","buttonText").append("foreignObject").attr("class","buttonText").attr("x",a).attr("y",n).attr("width",100).attr("height",20).style("font-color","#ddd").attr("font-weight","bold").attr("pointer-events","none").attr("dy","0.35em").append("xhtml:div").style("font","14px 'Helvetica Neue'").html('<span ><svg style="width:24px;height:24px" viewBox="0 0 24 26"><path fill="currentColor" d="M12 5.5L10 8H14L12 5.5M18 10V14L20.5 12L18 10M6 10L3.5 12L6 14V10M14 16H10L12 18.5L14 16M21 3H3C1.9 3 1 3.9 1 5V19C1 20.1 1.9 21 3 21H21C22.1 21 23 20.1 23 19V5C23 3.9 22.1 3 21 3M21 19H3V5H21V19Z" /></svg> <span> ').attr("pointer-events","none"),w();function w(){setTimeout(ie,3e3)}function ie(){N(".reset").remove(),N(".buttonText").remove()}}o.append("g").attr("class","buttons").append("rect").attr("class","buttons").attr("x",g-100).attr("y",5).attr("width",110).attr("height",20).attr("pointer-events","all").attr("opacity",0).on("mouseover",()=>{Ne(g-20,20,g-32,9)}),o.append("g").attr("class","buttons").append("rect").attr("class","buttons").attr("x",10).attr("y",5).attr("width",110).attr("height",20).attr("pointer-events","all").attr("opacity",0).on("mouseover",()=>{Ne(20,20,8,9)})}const ft=async function(l){Z.stopPropagation();let r=G(this),f=r.classed("focus");await Q(),!f&&(K=l.dimension,r.classed("focus",!0),z(l,{fixHighlight:!0}),it(l.dimension,l.name))},mt=async function(l){Z.stopPropagation();const r=G(this),f=r.classed("focus");if(await Q(),f)return;K=l.dimension,r.classed("focus",!0),z(l,{fixHighlight:!0});let m=N(".node").filter(function(g){return ce(l,g)}).data().map(g=>g.name);ut(l.dimension,m)},dt=async function(l){Z.stopPropagation();let r=G(this),f=r.classed("focusLink");await Q(),!f&&(r.classed("focusLink",!0),pt(l,{fixHighlight:!0}),st({link:l,source:l.source,target:l.target}))};function Q(){return K=null,N(".focus").classed("focus",!1),N(".focusLink").classed("focusLink",!1),O({unfixHighlight:!0}),ct()}let Y;function z(o,{fixHighlight:l=!1}={}){Y||E||(N(".node").style("opacity",r=>ce(o,r)?1:.3),N(".link").style("opacity",r=>ce(o,r)?1:.3),l&&(Y=!0))}let E;function pt(o,{fixHighlight:l=!1}={}){Y||E||(N(".node").style("opacity",r=>Te(o,r)?1:.4),N(".link").style("opacity",r=>Te(o,r)?1:.6),l&&(E=!0))}function O({unfixHighlight:o=!1}={}){o&&(Y=!1,E=!1),!(Y||E)&&(N(".node").style("opacity",1),N(".link").style("opacity",1))}function ce(o,l){return!!(l===o||o.source===l||o.target===l||Ce(o,l)||Se(o,l))}function Te(o,l){return l===o||o.source===l||o.target===l}function Ce(o,l){o=o.source?o.source:o;let r=l.target?[l.target]:l.sourceLinks.map(f=>f.target);return r.includes(o)?!0:r.some(f=>Ce(o,f))}function Se(o,l){o=o.target?o.target:o;let r=l.source?[l.source]:l.targetLinks.map(f=>f.source);return r.includes(o)?!0:r.some(f=>Se(o,f))}function gt(o,l){o.each(function(){let r=G(this),f=r.text().split(/\s+/).reverse(),k,x=[],m=r.attr("y"),g=parseFloat(r.attr("dy")),d=r.text(null).append("tspan").attr("y",m).attr("dx",0),C=[d];setTimeout(()=>{for(;k=f.pop();)if(x.push(k),d.text(x.join(" ")),d.node().getComputedTextLength()>l){x.pop(),d.text(x.join(" ")),x=[k];let c=d.node().getComputedTextLength();d=r.append("tspan").attr("y",m).attr("dx",c*-1).text(k),C.push(d)}if(C.length<=1)return;let A=-(C.length-1)/2;for(let c=0;c<C.length;c++){let S=C[c],y=A+c+g;S.attr("dy",y+"em")}},0)})}export{At as draw,zt as parse};
//# sourceMappingURL=source-target-sankey-CrOoRoce.js.map
